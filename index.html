<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZMBX Texture Ripper for Mecabricks</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'Roboto', sans-serif;
        background: #121212;
        color: #e0e0e0;
        text-align: center;
        padding-bottom: 50px;
    }
    header {
        background: linear-gradient(#643173, #7d5ba6);
        color: white;
        padding: 25px 40px;
        font-size: 2em;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        margin: 30px auto;
        width: fit-content;
    }
    form {
        background: #1f1f2e;
        margin: 40px auto;
        padding: 35px 25px;
        max-width: 500px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    input[type="file"] {
        background: #2c2c3d;
        border: none;
        padding: 10px;
        border-radius: 8px;
        color: #fff;
        margin: 15px 0;
        width: 100%;
    }
    button {
        background: #643173;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
    }
    button:hover { background: linear-gradient(#643173, #7d5ba6); }
    .gallery {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }
    .card {
        background: #1f1f2e;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        width: 220px;
        text-align: center;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    }
    .card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-bottom: 2px solid #2c2c3d;
    }
    .card a {
        display: block;
        padding: 10px;
        background: #643173;
        color: white;
        text-decoration: none;
        font-weight: bold;
        transition: background 0.3s;
    }
    .card a:hover { background: #6a11cb; }
    .zip-btn { margin-top: 30px; }
    .zip-btn button {
        padding: 14px 28px;
        font-size: 1.1em;
        border-radius: 12px;
    }
    footer {
        margin-top: 50px;
        font-size: 0.9em;
        color: #aaa;
    }
    footer a {
        color: #ff79c6;
        text-decoration: none;
        transition: color 0.3s;
    }
    footer a:hover { color: #c55fa3; }
</style>
</head>
<body>

<header>Mecabricks ZMBX Texture Ripper</header>

<form id="uploadForm">
    <label for="file">Select a .zmbx file to decode images:</label>
    <input type="file" id="fileInput" accept=".zmbx" required>
    <button type="submit">Rip</button>
</form>

<div class="gallery" id="gallery"></div>

<div class="zip-btn" id="zipBtnContainer" style="display:none;">
    <button id="downloadZipBtn">â¬‡ Download All as ZIP</button>
</div>

<footer>
    Original code by
    <a href="https://www.youtube.com/@spideycomic_15" target="_blank">Spideycomic</a>
</footer>

<script>
const form = document.getElementById('uploadForm');
const fileInput = document.getElementById('fileInput');
const gallery = document.getElementById('gallery');
const zipBtnContainer = document.getElementById('zipBtnContainer');
const downloadZipBtn = document.getElementById('downloadZipBtn');

let images = [];

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    gallery.innerHTML = '';
    images = [];

    const file = fileInput.files[0];
    if (!file) return;

    const jszip = new JSZip();
    const zip = await jszip.loadAsync(file);
    if (!zip.files['scene.mbx']) {
        alert('scene.mbx not found in .zmbx file');
        return;
    }

    const sceneText = await zip.files['scene.mbx'].async('string');
    let scene;
    try { scene = JSON.parse(sceneText); } catch(e) { alert('Invalid scene.mbx JSON'); return; }

    decodeRecursive(scene, '');

    function decodeRecursive(obj, prefix) {
        if (Array.isArray(obj)) {
            obj.forEach((item, idx) => decodeRecursive(item, prefix ? `${prefix}_${idx}` : idx));
        } else if (typeof obj === 'object' && obj !== null) {
            Object.entries(obj).forEach(([k,v]) => decodeRecursive(v, prefix ? `${prefix}_${k}` : k));
        } else if (typeof obj === 'string') {
            const trimmed = obj.trim();
            if (trimmed.startsWith('iVBOR') || trimmed.startsWith('/9j/')) {
                const ext = trimmed.startsWith('iVBOR') ? '.png' : '.jpg';
                const name = `${prefix}${ext}`;
                const binary = atob(trimmed);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                const blob = new Blob([array], {type: ext === '.png' ? 'image/png' : 'image/jpeg'});
                images.push({name, blob});

                const url = URL.createObjectURL(blob);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<img src="${url}" alt="${name}"><a href="${url}" download="${name}">Download ${name}</a>`;
                gallery.appendChild(card);
            }
        }
    }

    if (images.length > 0) zipBtnContainer.style.display = 'block';
    else zipBtnContainer.style.display = 'none';
});

downloadZipBtn.addEventListener('click', async () => {
    const zip = new JSZip();
    images.forEach(img => zip.file(img.name, img.blob));
    const content = await zip.generateAsync({type:"blob"});
    const url = URL.createObjectURL(content);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'DecodedImages.zip';
    a.click();
});
</script>

</body>
</html>
